name: CI
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest # Can use ubuntu-latest now we control installation

    steps:
      - uses: actions/checkout@v2

      # Setup a managed Python environment (Good practice, helps manage dependencies)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Buildozer and dependencies (Fixes 'externally-managed' error)
        run: |
          pip install --upgrade buildozer --break-system-packages
          # Also install any other required dependencies using this method if needed

      # ... (rest of your steps remain the same)
      - name: Get Date
        id: get-date
        # ... (date script)

      - name: Cache Buildozer global directory
        # ...

      # ... (Cache Buildozer local directory)

      - name: Build with Buildozer Command
        # Instead of 'uses: ArtemSBulgakov/buildozer-action@v1', we just run the command
        id: buildozer_run_command # New ID for the step output
        run: buildozer android debug
        # You can use the `env:` block here if you need specific environment variables
        # for the build process, like ANDROID_HOME or NDK_HOME.
        
      # We need a way to get the output filename, which the previous action provided.
      # Buildozer usually outputs to 'bin/*.apk'. We need to find that path dynamically.

      - name: Find the generated APK file path
        id: find_apk
        run: |
          APK_PATH=$(find bin -name "*.apk" | head -n 1)
          echo "::set-output name=filename::$APK_PATH"

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: package
          # Use the output from the *new* step ID
          path: ${{ steps.find_apk.outputs.filename }}

